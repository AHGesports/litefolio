---
import { CONTACT } from '../consts';
---

<!-- Modal backdrop -->
<div
  id="contact-modal-backdrop"
  class="fixed inset-0 bg-black/80 z-50 hidden opacity-0 transition-opacity duration-200"
  aria-hidden="true"
>
  <!-- Modal container -->
  <div
    id="contact-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="contact-modal-title"
    class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-lg max-h-[85vh] bg-dark-card border border-dark-border rounded-2xl shadow-2xl scale-95 opacity-0 transition-all duration-200 flex flex-col overflow-hidden"
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-6 pb-4 border-b border-dark-border shrink-0">
      <h2 id="contact-modal-title" class="text-xl md:text-2xl font-medium tracking-tighter bg-clip-text text-transparent bg-gradient-to-br from-background via-background to-secondary">
        Send a Message
      </h2>
      <button
        id="contact-modal-close"
        class="p-2 rounded-lg hover:bg-dark-border transition-colors text-muted-foreground hover:text-background"
        aria-label="Close modal"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Form Content -->
    <div class="flex-1 overflow-y-auto p-6 pt-4">
      <form id="contact-form" class="space-y-5">
        <!-- Hidden fields for Web3Forms -->
        <input type="hidden" name="access_key" value={CONTACT.WEB3FORMS_KEY} />
        <input type="hidden" name="subject" value={CONTACT.FORM_SUBJECT} />
        <input type="hidden" name="from_name" value={CONTACT.FROM_NAME} />
        <!-- Honeypot spam protection -->
        <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />

        <!-- Name -->
        <div class="space-y-2">
          <label for="contact-name" class="text-xs uppercase tracking-widest text-muted-foreground">
            Name <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            id="contact-name"
            name="name"
            required
            placeholder="Your name"
            class="w-full bg-transparent border-b border-white/20 focus:border-white/60 px-0 py-2 text-white placeholder:text-white/30 outline-none transition-colors"
          />
        </div>

        <!-- Email -->
        <div class="space-y-2">
          <label for="contact-email" class="text-xs uppercase tracking-widest text-muted-foreground">
            Email <span class="text-red-400">*</span>
          </label>
          <input
            type="email"
            id="contact-email"
            name="email"
            required
            placeholder="your@email.com"
            class="w-full bg-transparent border-b border-white/20 focus:border-white/60 px-0 py-2 text-white placeholder:text-white/30 outline-none transition-colors"
          />
        </div>

        <!-- Company (optional) -->
        <div class="space-y-2">
          <label for="contact-company" class="text-xs uppercase tracking-widest text-muted-foreground">
            Company <span class="text-white/30">(optional)</span>
          </label>
          <input
            type="text"
            id="contact-company"
            name="company"
            placeholder="Your company"
            class="w-full bg-transparent border-b border-white/20 focus:border-white/60 px-0 py-2 text-white placeholder:text-white/30 outline-none transition-colors"
          />
        </div>

        <!-- Message -->
        <div class="space-y-2">
          <label for="contact-message" class="text-xs uppercase tracking-widest text-muted-foreground">
            Message <span class="text-red-400">*</span>
          </label>
          <textarea
            id="contact-message"
            name="message"
            required
            rows="4"
            placeholder="Tell me about your project..."
            class="w-full bg-transparent border-b border-white/20 focus:border-white/60 px-0 py-2 text-white placeholder:text-white/30 outline-none transition-colors resize-none"
          ></textarea>
        </div>

        <!-- Result message -->
        <div id="contact-result" class="hidden text-sm py-2"></div>

        <!-- Submit button -->
        <button
          type="submit"
          id="contact-submit"
          class="w-full py-3 px-6 bg-white text-foreground font-medium rounded-full hover:bg-white/90 transition-colors flex items-center justify-center gap-2"
        >
          <span id="submit-text">Send Message</span>
          <svg id="submit-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const backdrop = document.getElementById('contact-modal-backdrop');
  const modal = document.getElementById('contact-modal');
  const closeBtn = document.getElementById('contact-modal-close');
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const result = document.getElementById('contact-result');
  const submitBtn = document.getElementById('contact-submit');
  const submitText = document.getElementById('submit-text');
  const submitSpinner = document.getElementById('submit-spinner');

  let currentTrigger: HTMLElement | null = null;

  function openContactModal(trigger: HTMLElement) {
    currentTrigger = trigger;
    backdrop?.classList.remove('hidden');
    requestAnimationFrame(() => {
      backdrop?.classList.remove('opacity-0');
      modal?.classList.remove('scale-95', 'opacity-0');
      modal?.classList.add('scale-100', 'opacity-100');
    });
    document.body.style.overflow = 'hidden';
    closeBtn?.focus();
  }

  function closeContactModal() {
    backdrop?.classList.add('opacity-0');
    modal?.classList.remove('scale-100', 'opacity-100');
    modal?.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      backdrop?.classList.add('hidden');
      // Reset form and result
      form?.reset();
      if (result) {
        result.classList.add('hidden');
        result.textContent = '';
      }
    }, 200);

    document.body.style.overflow = '';
    currentTrigger?.focus();
  }

  // Close button click
  closeBtn?.addEventListener('click', closeContactModal);

  // Backdrop click
  backdrop?.addEventListener('click', (e) => {
    if (e.target === backdrop) {
      closeContactModal();
    }
  });

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !backdrop?.classList.contains('hidden')) {
      closeContactModal();
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Show loading state
    if (submitBtn) submitBtn.setAttribute('disabled', 'true');
    if (submitText) submitText.textContent = 'Sending...';
    if (submitSpinner) submitSpinner.classList.remove('hidden');
    if (result) result.classList.add('hidden');

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const json = await response.json();

      if (response.status === 200) {
        if (result) {
          result.textContent = 'Message sent successfully! I\'ll get back to you soon.';
          result.className = 'text-sm py-2 text-green-400';
          result.classList.remove('hidden');
        }
        form.reset();
      } else {
        throw new Error(json.message || 'Something went wrong');
      }
    } catch (error) {
      if (result) {
        result.textContent = error instanceof Error ? error.message : 'Something went wrong. Please try again.';
        result.className = 'text-sm py-2 text-red-400';
        result.classList.remove('hidden');
      }
    } finally {
      // Reset button state
      if (submitBtn) submitBtn.removeAttribute('disabled');
      if (submitText) submitText.textContent = 'Send Message';
      if (submitSpinner) submitSpinner.classList.add('hidden');
    }
  });

  // Listen for trigger clicks
  document.addEventListener('DOMContentLoaded', () => {
    const triggers = document.querySelectorAll('[data-contact-modal]');
    triggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        openContactModal(trigger as HTMLElement);
      });
      trigger.addEventListener('keydown', (e) => {
        if ((e as KeyboardEvent).key === 'Enter' || (e as KeyboardEvent).key === ' ') {
          e.preventDefault();
          openContactModal(trigger as HTMLElement);
        }
      });
    });
  });
</script>
