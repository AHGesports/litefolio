---
import { SEO } from "astro-seo";
import { SITE } from "../consts";
import SpeedInsights from "@vercel/speed-insights/astro";
import Analytics from "@vercel/analytics/astro";

interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <SEO
      title={`${SITE.TITLE} - Portfolio`}
      description={SITE.DESCRIPTION}
      openGraph={{
        basic: {
          title: `${SITE.TITLE} - Portfolio`,
          type: "website",
          image: "/assets/preview.png",
        },
      }}
    />
    <meta charset="UTF-8" />
    <meta
      name="description"
      content={SITE.DESCRIPTION}
    />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <!-- Preload critical fonts for faster FCP/LCP -->
    <link rel="preload" href="/fonts/IBMPlexMono-Bold-latin.woff2" as="font" type="font/woff2" crossorigin fetchpriority="high" />
    <link rel="preload" href="/fonts/GeistVF.woff" as="font" type="font/woff" crossorigin fetchpriority="high" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- OverlayScrollbars CSS -->
    <link rel="stylesheet" href="/vendor/overlayscrollbars.min.css" />
  </head>
  <body
    class="relative flex flex-col w-full min-h-dvh bg-background"
  >
    <!-- Custom Cursor -->
    <div id="cursor" class="cursor" aria-hidden="true"></div>

    <slot />


    <!-- Cursor Script -->
    <script>
      const cursorEl = document.getElementById('cursor');
      if (cursorEl) {
        const cursor = cursorEl;
        let mouseX = 0, mouseY = 0;
        let cursorX = 0, cursorY = 0;
        let currentScale = 1, targetScale = 1;
        let isVisible = false;
        let isFirstMove = true;
        let animationId: number | null = null;
        let forceLowPerf = false; // For testing

        // Scale values for hover states
        const SCALE_DEFAULT = 1;
        const SCALE_HOVERING = 2.125;      // 68px / 32px
        const SCALE_HOVERING_MEDIA = 2.8125; // 90px / 32px

        // Respect reduced motion preference
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        // Check URL params for testing mode: ?cursor=lowperf or ?cursor=highperf
        const urlParams = new URLSearchParams(window.location.search);
        const cursorMode = urlParams.get('cursor');

        // Detect low-performance devices for fallback styling
        const detectLowPerformance = () => {
          // URL override for testing
          if (cursorMode === 'lowperf') return true;
          if (cursorMode === 'highperf') return false;
          if (forceLowPerf) return true;

          const lowCores = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2;
          const lowMemory = (navigator as any).deviceMemory && (navigator as any).deviceMemory <= 2;
          const chromeMatch = /Chrome\/(\d+)/.exec(navigator.userAgent);
          const chromeVersion = chromeMatch ? parseInt(chromeMatch[1]) : 999;
          const oldChrome = chromeVersion < 90;
          return lowCores || lowMemory || oldChrome;
        };

        let isLowPerformance = detectLowPerformance();

        // Apply low-performance class if needed
        const applyPerfMode = (lowPerf: boolean) => {
          if (lowPerf) {
            cursor.classList.add('low-performance');
          } else {
            cursor.classList.remove('low-performance');
          }
          isLowPerformance = lowPerf;
        };

        applyPerfMode(isLowPerformance);

        // Show cursor on first mouse move
        document.addEventListener('mousemove', (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;

          // Fix: Set initial position on first move (prevents jump from 0,0)
          if (isFirstMove) {
            cursorX = mouseX;
            cursorY = mouseY;
            updateTransform();
            isFirstMove = false;
          }

          if (!isVisible) {
            cursor.style.opacity = '1';
            isVisible = true;
          }

          // Start animation if not running
          if (!animationId) {
            animate();
          }
        });

        // Hide cursor when mouse leaves window
        document.addEventListener('mouseleave', () => {
          cursor.style.opacity = '0';
          isVisible = false;
        });

        // Update transform with both position and scale (GPU-only, no layout)
        function updateTransform() {
          cursor.style.transform = `translate3d(${cursorX - 16}px, ${cursorY - 16}px, 0) scale(${currentScale})`;
        }

        // Animation loop - interpolates both position AND scale
        function animate() {
          const dx = mouseX - cursorX;
          const dy = mouseY - cursorY;
          const ds = targetScale - currentScale;

          // Faster easing on low-perf devices
          const easing = isLowPerformance ? 0.25 : 0.15;
          cursorX += dx * easing;
          cursorY += dy * easing;
          currentScale += ds * easing;

          updateTransform();

          // Stop when cursor catches up (position within 0.5px, scale within 0.01)
          if (Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5 && Math.abs(ds) < 0.01) {
            animationId = null;
            return;
          }

          animationId = requestAnimationFrame(animate);
        }

        // Helper to set cursor state and target scale
        function setCursorState(state: 'default' | 'hovering' | 'hovering-media') {
          cursor.classList.remove('hovering', 'hovering-media');

          // Skip scale animation if user prefers reduced motion
          if (prefersReducedMotion) {
            if (state !== 'default') cursor.classList.add(state);
            return;
          }

          switch (state) {
            case 'hovering':
              cursor.classList.add('hovering');
              targetScale = SCALE_HOVERING;
              break;
            case 'hovering-media':
              cursor.classList.add('hovering-media');
              targetScale = SCALE_HOVERING_MEDIA;
              break;
            default:
              targetScale = SCALE_DEFAULT;
          }

          // Restart animation for scale interpolation
          if (!animationId) {
            animate();
          }
        }

        // React to interactive elements - exclude nav items and data-cursor="none"
        document.querySelectorAll('a:not(nav a):not([data-cursor="none"]), button:not(nav button):not([data-cursor="none"]), [role="button"]:not(nav [role="button"]):not([data-cursor="none"])').forEach(el => {
          el.addEventListener('mouseenter', () => setCursorState('hovering'));
          el.addEventListener('mouseleave', () => setCursorState('default'));
        });

        // React to media (videos only)
        document.querySelectorAll('video, [data-cursor="media"]').forEach(el => {
          el.addEventListener('mouseenter', () => setCursorState('hovering-media'));
          el.addEventListener('mouseleave', () => setCursorState('default'));
        });

        // Hide on touch devices
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
          cursor.style.display = 'none';
        }

        // Expose testing API globally
        (window as any).cursorDebug = {
          // Toggle low-performance mode
          setLowPerf: (enabled: boolean) => {
            forceLowPerf = enabled;
            applyPerfMode(enabled);
            console.log(`Cursor: ${enabled ? 'LOW' : 'HIGH'} performance mode`);
          },
          // Get current state
          getState: () => ({
            isLowPerformance,
            forceLowPerf,
            currentScale,
            targetScale,
            position: { x: cursorX, y: cursorY },
            mouse: { x: mouseX, y: mouseY },
            classes: Array.from(cursor.classList),
            computedStyles: {
              backdropFilter: getComputedStyle(cursor).backdropFilter,
              transform: getComputedStyle(cursor).transform,
              contain: getComputedStyle(cursor).contain,
            }
          }),
          // Device detection info
          getDeviceInfo: () => ({
            cores: navigator.hardwareConcurrency,
            memory: (navigator as any).deviceMemory,
            userAgent: navigator.userAgent,
            detectedLowPerf: detectLowPerformance(),
          }),
          // Help
          help: () => {
            console.log(`
╔════════════════════════════════════════════════════════════╗
║                  CURSOR DEBUG API                          ║
╠════════════════════════════════════════════════════════════╣
║ cursorDebug.setLowPerf(true)   - Enable low-perf mode      ║
║ cursorDebug.setLowPerf(false)  - Enable high-perf mode     ║
║ cursorDebug.getState()         - Get current cursor state  ║
║ cursorDebug.getDeviceInfo()    - Get device capabilities   ║
╠════════════════════════════════════════════════════════════╣
║ URL Parameters:                                            ║
║   ?cursor=lowperf   - Force low-performance mode           ║
║   ?cursor=highperf  - Force high-performance mode          ║
╚════════════════════════════════════════════════════════════╝
            `);
          }
        };

        // Log help hint on load
        if (cursorMode) {
          console.log(`Cursor: Forced ${cursorMode} mode via URL parameter`);
        }
      }
    </script>

    <!-- OverlayScrollbars -->
    <script is:inline src="/vendor/overlayscrollbars.min.js"></script>
    <script is:inline>
      var OS = OverlayScrollbarsGlobal.OverlayScrollbars;
      // Initialize on body
      OS(document.body, {});
      // Initialize on modal content areas
      document.querySelectorAll('#skills-modal-content, #contact-modal .overflow-y-auto').forEach(function(el) {
        OS(el, {});
      });

      // Context-aware scrollbar color (like navbar)
      (function() {
        var darkSections = document.querySelectorAll('#projects, #contact');
        var viewportHeight = window.innerHeight;

        function checkScrollbarColor() {
          var scrollY = window.scrollY;
          var viewportMiddle = scrollY + viewportHeight / 2;
          var isOverDark = false;

          darkSections.forEach(function(section) {
            var rect = section.getBoundingClientRect();
            var sectionTop = scrollY + rect.top;
            var sectionBottom = sectionTop + rect.height;
            if (viewportMiddle >= sectionTop && viewportMiddle <= sectionBottom) {
              isOverDark = true;
            }
          });

          if (isOverDark) {
            document.body.classList.add('scrollbar-dark-bg');
          } else {
            document.body.classList.remove('scrollbar-dark-bg');
          }
        }

        window.addEventListener('scroll', checkScrollbarColor, { passive: true });
        window.addEventListener('resize', function() { viewportHeight = window.innerHeight; }, { passive: true });
        checkScrollbarColor();
      })();
    </script>

    <!-- Cal.com Embed (deferred) -->
    <script is:inline>
      // Load Cal.com after page is interactive
      if (document.readyState === 'complete') {
        initCal();
      } else {
        window.addEventListener('load', initCal);
      }
      function initCal() {
        (function (C, A, L) {
          let p = function (a, ar) { a.q.push(ar); };
          let d = C.document;
          C.Cal = C.Cal || function () {
            let cal = C.Cal;
            let ar = arguments;
            if (!cal.loaded) {
              cal.ns = {}; cal.q = cal.q || [];
              d.head.appendChild(d.createElement("script")).src = A;
              cal.loaded = true;
            }
            if (ar[0] === L) {
              const api = function () { p(api, arguments); };
              const namespace = ar[1];
              api.q = api.q || [];
              if (typeof namespace === "string") {
                cal.ns[namespace] = api;
                p(api, ar);
              } else {
                p(cal, ar);
              }
              return;
            }
            p(cal, ar);
          };
        })(window, "https://app.cal.com/embed/embed.js", "init");
        Cal("init", { origin: "https://cal.com" });
        Cal("ui", {"styles":{"branding":{"brandColor":"#000000"}},"hideEventTypeDetails":false,"layout":"month_view"});
      }
    </script>

    <!-- Analytics (end of body for better FCP) -->
    <Analytics />
    <SpeedInsights />
  </body>
</html>

<style is:global>
  @tailwind base;
  @tailwind components;
  @tailwind utilities;

  @layer base {
    :root {
      --primary: 252, 100%, 64%;
      --secondary: 254, 100%, 73%;
      --background: 0, 0%, 100%;
      --foreground: 0, 0%, 9%;
      --card: 0, 0%, 98%;
      --dark-card: 0, 0%, 7%;
      --muted: 0, 0%, 92%;
      --muted-foreground: 0, 0%, 40%;
      --accent: 0, 0%, 92%;
      --border: 220 13% 91%;
      --dark-border: 0, 0%, 11%;
    }
  }

  @layer base {
    /* Self-hosted fonts for faster FCP/LCP (no external CSS blocking) */
    @font-face {
      font-family: "IBM Plex Mono";
      src: url("/fonts/IBMPlexMono-Bold-latin.woff2") format("woff2");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Geist";
      src: url("/fonts/GeistVF.woff") format("woff");
      font-display: swap;
    }
    * {
      @apply border-border;
    }
    html {
      scroll-padding-top: 6rem;
    }
    body {
      font-family: "Geist", system-ui, sans-serif;
      @apply bg-background text-foreground;
    }
  }

  /* Hide native scrollbars */
  html, body {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  html::-webkit-scrollbar,
  body::-webkit-scrollbar {
    display: none;
  }

  .perfect-shadow {
    box-shadow: var(--perfect-shadow);
    --base: hsl(214 80% 27% / 4%);
    --shade: hsl(from var(--base) calc(h + 8) 25 calc(l - 5));
    --perfect-shadow: 0 0 0 1px var(--base), 0 1px 1px -0.5px var(--shade),
      0 3px 3px -1.5px var(--shade), 0 6px 6px -3px var(--shade),
      0 12px 12px -6px var(--base), 0 24px 24px -12px var(--base);
  }
  .font-plex {
    font-family: "IBM Plex Mono", monospace;
  }

  /* Custom Cursor Styles */
  @media (hover: hover) and (pointer: fine) {
    * {
      cursor: none !important;
    }
  }

  .cursor {
    position: fixed;
    top: 0;
    left: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;

    /* PERF: Only opacity transitions via CSS; scale is JS-animated */
    transition: opacity 0.2s ease;

    /* GPU acceleration hints */
    will-change: transform;
    backface-visibility: hidden;
    transform-origin: center center;

    /* PERF: Isolate paint/layout to this element only */
    contain: layout style paint;
    isolation: isolate;

    /* Glass lens - reduced blur radius (4px vs 6px = ~45% less GPU work) */
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);

    /* Glass effect - simplified 2-stop gradient */
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.12) 0%,
      rgba(0, 0, 0, 0.03) 100%
    );
    border: 1px solid rgba(128, 128, 128, 0.3);

    /* Reduced to 2 shadows (outer + inset highlight) */
    box-shadow:
      0 2px 12px rgba(0, 0, 0, 0.12),
      inset 0 1px 1px rgba(255, 255, 255, 0.25);
  }

  /* Fallback for browsers without backdrop-filter support */
  @supports not (backdrop-filter: blur(1px)) {
    .cursor {
      background: rgba(200, 200, 200, 0.35);
    }
  }

  /* Low-performance mode: disable expensive effects */
  .cursor.low-performance {
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    background: rgba(180, 180, 180, 0.25);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: opacity 0.15s ease;
  }

  /* Hovering links/buttons - reduced blur when scaled */
  .cursor.hovering {
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }

  .cursor.low-performance.hovering {
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    background: rgba(180, 180, 180, 0.2);
  }

  /* Hovering images/videos - minimal blur when large */
  .cursor.hovering-media {
    backdrop-filter: blur(1.5px);
    -webkit-backdrop-filter: blur(1.5px);
  }

  .cursor.low-performance.hovering-media {
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    background: rgba(180, 180, 180, 0.18);
  }

  /* Hide cursor on touch devices */
  @media (hover: none), (pointer: coarse) {
    .cursor {
      display: none !important;
    }
    * {
      cursor: auto !important;
    }
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .cursor {
      transition: opacity 0.2s ease;
    }
  }
</style>
