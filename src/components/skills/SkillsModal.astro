---
import { SKILL_CATEGORIES } from '../../data/skills';
---

<!-- Modal backdrop -->
<div
  id="skills-modal-backdrop"
  class="fixed inset-0 bg-black/80 z-50 hidden opacity-0 transition-opacity duration-200"
  aria-hidden="true"
>
  <!-- Modal container -->
  <div
    id="skills-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="skills-modal-title"
    class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-4xl max-h-[85vh] bg-dark-card border border-dark-border rounded-2xl shadow-2xl scale-95 opacity-0 transition-[transform,opacity] duration-200 flex flex-col overflow-hidden"
  >
    <!-- Header - Fixed at top -->
    <div class="flex items-center justify-between p-6 pb-4 border-b border-dark-border shrink-0">
      <h2 id="skills-modal-title" class="text-xl md:text-2xl font-medium tracking-tighter bg-clip-text text-transparent bg-gradient-to-br from-background via-background to-secondary">
        Technical Skills
      </h2>
      <button
        id="skills-modal-close"
        class="p-2 rounded-lg hover:bg-dark-border transition-colors text-[hsl(0,0%,60%)] hover:text-background"
        aria-label="Close modal"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Skills Content - Scrollable area (PERF: Content rendered lazily via JS) -->
    <div id="skills-modal-content" class="flex-1 overflow-y-auto p-6 pt-4 flex flex-col gap-6">
      <!-- Content will be injected by JavaScript when modal opens -->
    </div>
  </div>
</div>

<!-- Override OverlayScrollbars flex-direction that breaks modal layout -->
<style>
  #skills-modal-content,
  #skills-modal-content [data-overlayscrollbars-viewport] {
    flex-direction: column !important;
    gap: 2.5rem !important; /* Increased spacing between subsections */
  }
</style>

<!-- PERF FIX: Store skills data as JSON for lazy loading -->
<script type="application/json" id="skills-data" set:html={JSON.stringify(SKILL_CATEGORIES)}></script>

<script>
  interface Skill {
    id: string;
    name: string;
    icon?: string;
  }

  interface SkillSubsection {
    title: string;
    skills: Skill[];
  }

  interface SkillCategory {
    id: string;
    title: string;
    previewIcons: { src: string; alt: string }[];
    subsections: SkillSubsection[];
  }

  const backdrop = document.getElementById('skills-modal-backdrop');
  const modal = document.getElementById('skills-modal');
  const closeBtn = document.getElementById('skills-modal-close');
  const modalTitle = document.getElementById('skills-modal-title');
  const modalContent = document.getElementById('skills-modal-content');

  // Parse skills data from JSON script tag
  const skillsDataElement = document.getElementById('skills-data');
  const skillCategories: SkillCategory[] = skillsDataElement
    ? JSON.parse(skillsDataElement.textContent || '[]')
    : [];

  const categoryTitles: Record<string, string> = {
    'languages': 'Languages',
    'backend': 'Backend',
    'frontend': 'Frontend',
    'devops': 'DevOps & Quality',
    'ai-automation': 'AI & Automation',
    'specialized': 'Specialized'
  };

  let currentTrigger: HTMLElement | null = null;
  let modalScrollbarInstance: any = null;

  // Get OverlayScrollbars from global (must be called at runtime, not at script load)
  const getOS = () => (window as any).OverlayScrollbarsGlobal?.OverlayScrollbars;

  // PERF FIX: Build skill item DOM element using createElement (safe, no XSS)
  function createSkillItem(skill: Skill): HTMLDivElement {
    const item = document.createElement('div');
    // PERF FIX: Changed transition-all to transition-colors (specific property)
    item.className = 'flex items-center gap-2 px-3 py-1.5 bg-white/5 border border-white/10 rounded-full text-sm text-white/90 hover:bg-primary/20 hover:border-primary/30 hover:text-white transition-colors duration-200 cursor-default';

    const img = document.createElement('img');
    img.src = skill.icon || '/logos/default.svg';
    img.alt = '';
    img.className = 'w-4 h-4 opacity-80';
    img.setAttribute('aria-hidden', 'true');

    const span = document.createElement('span');
    span.textContent = skill.name;

    item.appendChild(img);
    item.appendChild(span);

    return item;
  }

  // PERF FIX: Build subsection DOM element
  function createSubsection(subsection: SkillSubsection, isLast: boolean = false): HTMLDivElement {
    const container = document.createElement('div');
    container.className = isLast ? 'w-full' : 'w-full mb-8';

    // Subsection title
    const title = document.createElement('h3');
    title.className = 'text-xs uppercase tracking-widest text-[hsl(0,0%,60%)] mb-3 flex items-center gap-2';

    const dot = document.createElement('span');
    dot.className = 'w-2 h-2 rounded-full bg-primary/50';

    const titleText = document.createTextNode(subsection.title);

    title.appendChild(dot);
    title.appendChild(titleText);

    // Skills container
    const skillsContainer = document.createElement('div');
    skillsContainer.className = 'flex flex-wrap gap-2';

    // Add each skill
    subsection.skills.forEach(skill => {
      skillsContainer.appendChild(createSkillItem(skill));
    });

    container.appendChild(title);
    container.appendChild(skillsContainer);

    return container;
  }

  // PERF FIX: Clear all children from an element safely
  function clearChildren(element: HTMLElement): void {
    while (element.firstChild) {
      element.removeChild(element.firstChild);
    }
  }

  // PERF FIX: Build category content lazily when modal opens
  function renderCategoryContent(categoryId: string): void {
    if (!modalContent) return;

    // Clear existing content safely
    clearChildren(modalContent);

    // Find the category
    const category = skillCategories.find(cat => cat.id === categoryId);
    if (!category) return;

    // Build and append subsections
    const lastIndex = category.subsections.length - 1;
    category.subsections.forEach((subsection, index) => {
      modalContent.appendChild(createSubsection(subsection, index === lastIndex));
    });
  }

  function openModal(categoryId: string, trigger: HTMLElement) {
    currentTrigger = trigger;

    // Update title
    if (modalTitle) {
      modalTitle.textContent = categoryTitles[categoryId] || 'Technical Skills';
    }

    // PERF FIX: Render content lazily (only when modal opens)
    renderCategoryContent(categoryId);

    // Initialize OverlayScrollbars on modal content for consistent scrollbar styling
    const OS = getOS();
    if (OS && modalContent) {
      // Check for existing instance from body's OverlayScrollbars
      const existingInstance = OS(modalContent);
      if (existingInstance) {
        // Destroy existing instance that has wrong settings
        existingInstance.destroy();
      }
      // Create fresh instance with correct overflow settings
      modalScrollbarInstance = OS(modalContent, {
        overflow: { x: 'hidden', y: 'scroll' },
        scrollbars: { clickScroll: true }
      });
    }

    // Show modal
    backdrop?.classList.remove('hidden');
    requestAnimationFrame(() => {
      backdrop?.classList.remove('opacity-0');
      modal?.classList.remove('scale-95', 'opacity-0');
      modal?.classList.add('scale-100', 'opacity-100');
    });

    document.body.style.overflow = 'hidden';
    closeBtn?.focus();
  }

  function closeModal() {
    backdrop?.classList.add('opacity-0');
    modal?.classList.remove('scale-100', 'opacity-100');
    modal?.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      backdrop?.classList.add('hidden');
      // Destroy OverlayScrollbars instance before clearing content
      if (modalScrollbarInstance) {
        modalScrollbarInstance.destroy();
        modalScrollbarInstance = null;
      }
      // PERF FIX: Clear content when modal closes to free up DOM
      if (modalContent) {
        clearChildren(modalContent);
      }
    }, 200);

    document.body.style.overflow = '';
    currentTrigger?.focus();
  }

  // Close button click
  closeBtn?.addEventListener('click', closeModal);

  // Backdrop click
  backdrop?.addEventListener('click', (e) => {
    if (e.target === backdrop) {
      closeModal();
    }
  });

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !backdrop?.classList.contains('hidden')) {
      closeModal();
    }
  });

  // Listen for skill card clicks
  document.addEventListener('DOMContentLoaded', () => {
    const skillCards = document.querySelectorAll('[data-skill-category]');
    skillCards.forEach((card) => {
      const categoryId = card.getAttribute('data-skill-category');

      card.addEventListener('click', () => {
        if (categoryId) {
          openModal(categoryId, card as HTMLElement);
        }
      });

      card.addEventListener('keydown', (e) => {
        if ((e as KeyboardEvent).key === 'Enter' || (e as KeyboardEvent).key === ' ') {
          e.preventDefault();
          if (categoryId) {
            openModal(categoryId, card as HTMLElement);
          }
        }
      });
    });
  });
</script>
